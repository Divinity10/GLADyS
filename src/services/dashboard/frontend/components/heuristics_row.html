{% from 'components/widgets/expandable_row.html' import expandable_row_start, expandable_row_drilldown_start, expandable_row_end, checkbox_cell, origin_badge_cell, condition_cell, active_toggle_cell, drilldown_info_grid %}

{# Heuristics Row - Uses expandable_row macros for consistent structure #}
{% set extra_state = "conditionText: `" ~ (h.condition_text|e) ~ "`, responseText: (function() { try { const json = JSON.parse(`" ~ (h.effects_json|e) ~ "`); return json.text || json.message || json.response || ''; } catch { return ''; } })(), confidence: " ~ h.confidence ~ ", dirty: false, saving: false, saved: false, deleting: false" %}

{{ expandable_row_start(h.id, 'grid-cols-[30px_80px_1fr_60px]', extra_state) }}

    {{ checkbox_cell(h.id, 'window.heuristicsSelection') }}
    {{ origin_badge_cell(h.origin) }}
    {{ condition_cell(h.condition_text, 80) }}
    {{ active_toggle_cell(h.id, h.active, 'toggleActive') }}

{{ expandable_row_drilldown_start(h.id) }}

    <!-- Info Section (read-only) -->
    <div class="p-3 bg-gray-900/80 border-b border-gray-700">
        {{ drilldown_info_grid([
            {'label': 'ID', 'value': h.id, 'mono': true},
            {'label': 'Origin', 'value': h.origin},
            {'label': 'Created', 'value': h.created_at or 'N/A'},
            {'label': 'Updated', 'value': h.updated_at or 'N/A'},
            {'label': 'Origin ID', 'value': h.origin_id or 'N/A', 'mono': true}
        ]) }}
        <!-- Fires link is custom, keep inline -->
        <div class="text-xs mt-2">
            <span class="text-gray-400 font-bold uppercase">Fires:</span>
            <span class="text-blue-400 hover:text-blue-300 hover:underline cursor-pointer ml-1"
                  onclick="window.dispatchEvent(new CustomEvent('switch-tab', { detail: { tab: 'response', filter: 'matched_heuristic_id', value: '{{ h.id }}' } }))">
                {{ h.fire_count or 0 }}
            </span>
            <span class="text-gray-500 ml-1">({{ h.success_count or 0 }} successes)</span>
        </div>
    </div>

    <!-- Editable Section -->
    <div class="p-3 bg-gray-600 space-y-2">
        <!-- Condition (full width) -->
        <div class="flex items-center gap-2">
            <label class="text-xs text-gray-300 font-bold uppercase shrink-0 w-20">Condition:</label>
            <input type="text" x-model="conditionText" @input="dirty = true"
                   class="flex-1 bg-gray-800 border border-gray-500 rounded px-2 py-1 text-xs font-mono text-gray-200 focus:outline-none focus:border-blue-500">
        </div>
        <!-- Response (full width) -->
        <div class="flex items-start gap-2">
            <label class="text-xs text-gray-300 font-bold uppercase shrink-0 w-20 pt-1">Response:</label>
            <textarea x-model="responseText" @input="dirty = true" rows="2" placeholder="Enter the response text..."
                      class="flex-1 bg-gray-800 border border-gray-500 rounded p-2 text-xs font-mono text-gray-200 focus:outline-none focus:border-blue-500"></textarea>
        </div>
        <!-- Confidence (small input, 4 chars width) -->
        <div class="flex items-center gap-2">
            <label class="text-xs text-gray-300 font-bold uppercase shrink-0 w-20">Confidence:</label>
            <input type="number" min="0" max="1" step="0.01" x-model="confidence" @input="dirty = true"
                   class="w-14 bg-gray-800 border border-gray-500 rounded px-2 py-1 text-xs text-gray-200 focus:outline-none focus:border-blue-500">
        </div>
        <div class="flex justify-end items-center gap-2 pt-3 border-t border-gray-600">
            <span x-show="dirty && !saving && !saved" class="text-yellow-400 text-xs mr-2">Unsaved</span>
            <span x-show="saved" class="text-green-400 text-xs mr-2">Saved!</span>
            <button @click="if(confirm('Delete this heuristic?')) { deleting = true; deleteHeuristic('{{ h.id }}'); }"
                    :disabled="deleting" class="text-red-400 hover:text-red-300 text-xs font-bold px-3 py-1"
                    x-text="deleting ? 'Deleting...' : 'Delete'"></button>
            <button @click="saving = true; saved = false; saveHeuristicFull('{{ h.id }}', '{{ h.origin }}', conditionText, responseText, confidence).then(() => { dirty = false; saving = false; saved = true; setTimeout(() => saved = false, 2000); })"
                    :disabled="!dirty || saving"
                    :class="dirty && !saving ? 'bg-blue-600 hover:bg-blue-500 text-white' : 'bg-gray-700 text-gray-500 cursor-not-allowed'"
                    class="px-4 py-1.5 rounded text-xs font-bold transition-colors"
                    x-text="saving ? 'Saving...' : 'Save'"></button>
        </div>
    </div>

{{ expandable_row_end() }}
