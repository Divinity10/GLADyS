<div id="llm-tab" class="flex flex-col gap-6" x-data="{
    status: {
        status: 'unknown',
        url: 'â€”',
        model: 'â€”',
        available_models: [],
        loaded_models: []
    },
    testPrompt: '',
    testResponse: null,
    testing: false,
    warming: false,
    loading: false,
    
    async fetchStatus() {
        this.loading = true;
        try {
            const resp = await fetch('/api/llm/status');
            const data = await resp.json();
            this.status = data;
        } catch (e) {
            console.error('Failed to fetch LLM status:', e);
            this.status.status = 'error';
        } finally {
            this.loading = false;
        }
    },
    
    async testLLM() {
        if (!this.testPrompt || this.testing) return;
        this.testing = true;
        this.testResponse = null;
        try {
            const resp = await fetch('/api/llm/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: this.testPrompt })
            });
            this.testResponse = await resp.json();
        } catch (e) {
            console.error('LLM test failed:', e);
            this.testResponse = { error: 'Test failed. Check server logs.' };
        } finally {
            this.testing = false;
        }
    },
    
    async warmModel() {
        this.warming = true;
        try {
            await fetch('/api/llm/warm', { method: 'POST' });
            this.fetchStatus();
        } catch (e) {
            console.error('Warming failed:', e);
        } finally {
            this.warming = false;
        }
    },
    
    init() {
        this.fetchStatus();
        this.interval = setInterval(() => this.fetchStatus(), 15000);
    },
    
    destroy() {
        if (this.interval) clearInterval(this.interval);
    }
}" x-init="init()" @destroy="destroy()">

    <!-- LLM Connection Status -->
    <div class="grid grid-cols-3 gap-6">
        <div class="col-span-2 bg-gray-800 p-4 border border-gray-700 rounded shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xs font-bold text-secondary uppercase tracking-widest">Ollama Connection</h2>
                <span class="flex items-center gap-3 ml-4">
                    <span class="service-dot" :class="{
                        'dot-green': status.status === 'connected',
                        'dot-red': status.status === 'unreachable',
                        'dot-yellow': status.status === 'error',
                        'dot-gray': status.status === 'unknown'
                    }"></span>
                    <span class="text-[10px] font-bold uppercase" :class="{
                        'text-green-400': status.status === 'connected',
                        'text-red-400': status.status === 'unreachable',
                        'text-yellow-400': status.status === 'error',
                        'text-secondary': status.status === 'unknown'
                    }" x-text="status.status"></span>
                </span>
            </div>
            
            <div class="grid grid-cols-2 gap-x-8 gap-y-4 text-xs">
                <div>
                    <label class="text-[10px] text-secondary uppercase block mb-1">Endpoint URL</label>
                    <code class="text-blue-400 font-mono" x-text="status.url"></code>
                </div>
                <div>
                    <label class="text-[10px] text-secondary uppercase block mb-1">Active Model (Config)</label>
                    <code class="text-white font-bold" x-text="status.model"></code>
                </div>
                <div class="col-span-2">
                    <label class="text-[10px] text-secondary uppercase block mb-2">Loaded Models</label>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="m in status.loaded_models" :key="m">
                            <span class="px-2 py-0.5 bg-gray-900 border border-gray-700 rounded text-[11px] text-green-300 font-mono" x-text="m"></span>
                        </template>
                        <template x-if="status.loaded_models.length === 0">
                            <span class="text-secondary italic text-[11px]">No models currently loaded in Ollama VRAM.</span>
                        </template>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button @click="warmModel()" class="btn btn-primary px-4 py-1 flex items-center gap-2" :disabled="warming">
                    <span x-show="!warming">ðŸ”¥ Keep Model Warm</span>
                    <span x-show="warming">Warming...</span>
                </button>
            </div>
        </div>

        <div class="bg-gray-800 p-4 border border-gray-700 rounded shadow-md flex flex-col">
            <h2 class="text-xs font-bold text-secondary uppercase tracking-widest mb-4">Available Models</h2>
            <div class="flex-1 overflow-auto space-y-1 pr-2">
                <template x-for="m in status.available_models" :key="m">
                    <div class="text-[11px] font-mono text-gray-300 py-1 border-b border-gray-700 last:border-0" x-text="m"></div>
                </template>
                <template x-if="status.available_models.length === 0">
                    <div class="text-secondary italic text-[11px]">No available models reported.</div>
                </template>
            </div>
        </div>
    </div>

    <!-- Interactive Tester -->
    <div class="bg-gray-800 p-4 border border-gray-700 rounded shadow-md flex-1 flex flex-col">
        <h2 class="text-xs font-bold text-secondary uppercase tracking-widest mb-4">Interactive Prompt Tester</h2>
        <div class="flex gap-4 flex-1" style="min-height: 300px;">
            <div style="width: 33%; flex-shrink: 0;" class="flex flex-col gap-2">
                <label class="text-[10px] text-secondary uppercase font-bold">Input Prompt</label>
                <textarea x-model="testPrompt" 
                          class="input-dense bg-gray-900 flex-1 p-3 text-sm font-sans" 
                          placeholder="Type a message to test LLM generation directly..."
                          @keyup.ctrl.enter="testLLM()"></textarea>
                <div class="flex justify-between items-center text-[10px] text-secondary gap-4">
                    <span>Ctrl+Enter to send</span>
                    <button @click="testLLM()" class="btn btn-primary px-6 py-2" :disabled="testing || !testPrompt">
                        <span x-show="!testing">ðŸš€ Send to LLM</span>
                        <span x-show="testing">Generating...</span>
                    </button>
                </div>
            </div>
            
            <div style="width: 67%;" class="flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <label class="text-[10px] text-secondary uppercase font-bold">Raw Response</label>
                    <template x-if="testResponse && testResponse.total_duration_ms">
                        <span class="text-[10px] text-secondary" x-text="`Latency: ${testResponse.total_duration_ms}ms`"></span>
                    </template>
                </div>
                <div class="bg-gray-900 border border-gray-700 rounded flex-1 p-3 font-mono text-sm overflow-auto select-text whitespace-pre-wrap"
                     :class="testResponse && testResponse.error ? 'text-red-400' : 'text-gray-300'">
                    <template x-if="!testResponse && !testing">
                        <span class="text-gray-600 italic">Response will appear here...</span>
                    </template>
                    <template x-if="testing">
                        <div class="flex gap-1">
                            <span class="animate-bounce">.</span>
                            <span class="animate-bounce delay-100">.</span>
                            <span class="animate-bounce delay-200">.</span>
                        </div>
                    </template>
                    <span x-text="testResponse ? (testResponse.response || testResponse.error) : ''"></span>
                </div>
            </div>
        </div>
    </div>
</div>
