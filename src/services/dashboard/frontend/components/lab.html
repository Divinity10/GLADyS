{% from 'components/widgets/data_table.html' import bulk_action_bar %}

<div id="lab-tab" class="flex flex-col h-full gap-4">
    <!-- Event Submission Form -->
    <div class="bg-gray-800 p-3 border border-gray-700 rounded sticky top-0 z-10">
        <form hx-post="/api/events" hx-target="#submit-status" hx-swap="innerHTML"
              x-data="{
                  advancedOpen: false,
                  salienceOpen: false,
                  salienceEnabled: false,
                  structuredOpen: false,
                  evaluationOpen: false,
                  entityOpen: false,
                  timestamp: '',
                  structuredPairs: [{ key: '', value: '' }],
                  evaluationPairs: [{ key: '', value: '' }],
                  init() { this.setTimestampNow(); },
                  setTimestampNow() {
                      const now = new Date();
                      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                      this.timestamp = now.toISOString().slice(0, 16);
                  },
                  addStructuredPair() {
                      this.structuredPairs.push({ key: '', value: '' });
                  },
                  removeStructuredPair(index) {
                      this.structuredPairs.splice(index, 1);
                      if (!this.structuredPairs.length) {
                          this.addStructuredPair();
                      }
                  },
                  addEvaluationPair() {
                      this.evaluationPairs.push({ key: '', value: '' });
                  },
                  removeEvaluationPair(index) {
                      this.evaluationPairs.splice(index, 1);
                      if (!this.evaluationPairs.length) {
                          this.addEvaluationPair();
                      }
                  },
                  resetForm() {
                      this.$el.reset();
                      this.advancedOpen = false;
                      this.salienceOpen = false;
                      this.salienceEnabled = false;
                      this.structuredOpen = false;
                      this.evaluationOpen = false;
                      this.entityOpen = false;
                      this.structuredPairs = [{ key: '', value: '' }];
                      this.evaluationPairs = [{ key: '', value: '' }];
                      this.setTimestampNow();
                  }
              }"
              x-init="init()"
              x-on:event-form-reset="resetForm()"
              hx-on::after-request="if(event.detail.successful) { var s=document.getElementById('submit-status'); var el=s&&s.querySelector('[data-event-id]'); if(el) addPendingEvent(el.dataset.eventId, el.dataset.source, el.dataset.text); this.dispatchEvent(new CustomEvent('event-form-reset', { bubbles: true })); if(typeof boostQueuePolling==='function') boostQueuePolling(); if(typeof clearStatusAfterDelay==='function') clearStatusAfterDelay(); }"
              class="space-y-3">
            <div class="grid grid-cols-1 md:grid-cols-[180px_1fr] gap-2">
                <div>
                    <label class="text-[10px] text-gray-400 uppercase tracking-wide">Source</label>
                    <select name="source" class="input-dense bg-gray-900 w-full mt-1">
                        <option value="sudoku">sudoku</option>
                        <option value="melvor">melvor</option>
                        <option value="minecraft">minecraft</option>
                        <option value="kitchen">kitchen</option>
                        <option value="smart_home">smart_home</option>
                        <option value="work">work</option>
                        <option value="health">health</option>
                        <option value="custom">custom...</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 uppercase tracking-wide">Event Text</label>
                    <textarea name="text" placeholder="Enter event text..." required rows="2"
                              class="input-dense bg-gray-900 w-full mt-1"></textarea>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-2">
                <div>
                    <label class="text-[10px] text-gray-400 uppercase tracking-wide">Intent</label>
                    <select name="intent" class="input-dense bg-gray-900 w-40 mt-1">
                        <option value="unknown" selected>unknown</option>
                        <option value="actionable">actionable</option>
                        <option value="informational">informational</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary px-4 py-1 mt-4">Submit</button>
                <button type="button" onclick="document.getElementById('batch-file').click()"
                        class="btn px-4 py-1 mt-4" title="Load events from a JSON file">Load JSON</button>
                <button type="button" class="btn px-4 py-1 mt-4"
                        @click="advancedOpen = !advancedOpen"
                        x-text="advancedOpen ? 'Hide Advanced Fields' : 'Show Advanced Fields'"></button>
                <input type="file" id="batch-file" accept=".json" class="hidden"
                       onchange="uploadBatchFile(this)" style="display:none">
            </div>

            <div x-show="advancedOpen" x-cloak class="space-y-3 border-t border-gray-700 pt-3 bg-gray-200 text-black rounded p-3">
                <div>
                    <label class="text-[10px] text-gray-700 uppercase tracking-wide">Origin Timestamp</label>
                    <input type="datetime-local" name="timestamp" x-model="timestamp"
                           :disabled="!advancedOpen"
                           class="input-dense bg-gray-900 w-full mt-1 md:w-80">
                </div>

                <div class="border border-gray-300 rounded bg-gray-100">
                    <button type="button" class="w-full flex items-center justify-between px-3 py-2 text-xs text-black font-medium hover:bg-gray-200"
                            @click="salienceOpen = !salienceOpen">
                        <span>Salience Override</span>
                        <span x-text="salienceOpen ? '-' : '+'"></span>
                    </button>
                    <div x-show="salienceOpen" x-cloak class="px-3 pb-3 space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-[200px_1fr] gap-2">
                            <div>
                                <label class="text-[10px] text-gray-700 uppercase tracking-wide">Preset Override</label>
                                <select name="salience_override" class="input-dense bg-gray-900 w-full mt-1">
                                    <option value="">System (Auto)</option>
                                    <option value="high">Force HIGH</option>
                                    <option value="low">Force LOW</option>
                                </select>
                            </div>
                            <label class="flex items-center gap-2 mt-4 text-xs text-black">
                                <input type="checkbox" x-model="salienceEnabled" class="rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-0 focus:ring-offset-0">
                                Enable manual salience vector
                            </label>
                        </div>
                        <div class="grid gap-2 text-xs border rounded p-2 transition-colors"
                             style="grid-template-columns: repeat(4, minmax(0, 1fr));"
                             :class="salienceEnabled ? 'bg-white border-gray-400' : 'bg-gray-300 border-gray-400'">
                            <label class="space-y-1 min-w-0">
                                <span class="text-[10px] font-medium text-black">Threat</span>
                                <input type="number" min="0" max="1" step="0.01" name="salience_threat" :disabled="!salienceEnabled" class="w-full rounded border border-gray-500 bg-white px-2 py-1 text-xs text-black disabled:bg-gray-300 disabled:text-gray-600 disabled:border-gray-400 disabled:cursor-not-allowed" style="box-sizing: border-box;">
                            </label>
                            <label class="space-y-1 min-w-0">
                                <span class="text-[10px] font-medium text-black">Opportunity</span>
                                <input type="number" min="0" max="1" step="0.01" name="salience_opportunity" :disabled="!salienceEnabled" class="w-full rounded border border-gray-500 bg-white px-2 py-1 text-xs text-black disabled:bg-gray-300 disabled:text-gray-600 disabled:border-gray-400 disabled:cursor-not-allowed" style="box-sizing: border-box;">
                            </label>
                            <label class="space-y-1 min-w-0">
                                <span class="text-[10px] font-medium text-black">Humor</span>
                                <input type="number" min="0" max="1" step="0.01" name="salience_humor" :disabled="!salienceEnabled" class="w-full rounded border border-gray-500 bg-white px-2 py-1 text-xs text-black disabled:bg-gray-300 disabled:text-gray-600 disabled:border-gray-400 disabled:cursor-not-allowed" style="box-sizing: border-box;">
                            </label>
                            <label class="space-y-1 min-w-0">
                                <span class="text-[10px] font-medium text-black">Novelty</span>
                                <input type="number" min="0" max="1" step="0.01" name="salience_novelty" :disabled="!salienceEnabled" class="w-full rounded border border-gray-500 bg-white px-2 py-1 text-xs text-black disabled:bg-gray-300 disabled:text-gray-600 disabled:border-gray-400 disabled:cursor-not-allowed" style="box-sizing: border-box;">
                            </label>
                            <label class="space-y-1 min-w-0">
                                <span class="text-[10px] font-medium text-black">Goal Relevance</span>
                                <input type="number" min="0" max="1" step="0.01" name="salience_goal_relevance" :disabled="!salienceEnabled" class="w-full rounded border border-gray-500 bg-white px-2 py-1 text-xs text-black disabled:bg-gray-300 disabled:text-gray-600 disabled:border-gray-400 disabled:cursor-not-allowed" style="box-sizing: border-box;">
                            </label>
                            <label class="space-y-1 min-w-0">
                                <span class="text-[10px] font-medium text-black">Social</span>
                                <input type="number" min="0" max="1" step="0.01" name="salience_social" :disabled="!salienceEnabled" class="w-full rounded border border-gray-500 bg-white px-2 py-1 text-xs text-black disabled:bg-gray-300 disabled:text-gray-600 disabled:border-gray-400 disabled:cursor-not-allowed" style="box-sizing: border-box;">
                            </label>
                            <label class="space-y-1 min-w-0">
                                <span class="text-[10px] font-medium text-black">Emotional</span>
                                <input type="number" min="0" max="1" step="0.01" name="salience_emotional" :disabled="!salienceEnabled" class="w-full rounded border border-gray-500 bg-white px-2 py-1 text-xs text-black disabled:bg-gray-300 disabled:text-gray-600 disabled:border-gray-400 disabled:cursor-not-allowed" style="box-sizing: border-box;">
                            </label>
                            <label class="space-y-1 min-w-0">
                                <span class="text-[10px] font-medium text-black">Actionability</span>
                                <input type="number" min="0" max="1" step="0.01" name="salience_actionability" :disabled="!salienceEnabled" class="w-full rounded border border-gray-500 bg-white px-2 py-1 text-xs text-black disabled:bg-gray-300 disabled:text-gray-600 disabled:border-gray-400 disabled:cursor-not-allowed" style="box-sizing: border-box;">
                            </label>
                            <label class="space-y-1 min-w-0">
                                <span class="text-[10px] font-medium text-black">Habituation</span>
                                <input type="number" min="0" max="1" step="0.01" name="salience_habituation" :disabled="!salienceEnabled" class="w-full rounded border border-gray-500 bg-white px-2 py-1 text-xs text-black disabled:bg-gray-300 disabled:text-gray-600 disabled:border-gray-400 disabled:cursor-not-allowed" style="box-sizing: border-box;">
                            </label>
                        </div>
                    </div>
                </div>

                <div class="border border-gray-300 rounded bg-gray-100">
                    <button type="button" class="w-full flex items-center justify-between px-3 py-2 text-xs text-black font-medium hover:bg-gray-200"
                            @click="structuredOpen = !structuredOpen">
                        <span>Structured Data</span>
                        <span x-text="structuredOpen ? '-' : '+'"></span>
                    </button>
                    <div x-show="structuredOpen" x-cloak class="px-3 pb-3 space-y-2">
                        <template x-for="(pair, index) in structuredPairs" :key="'structured-' + index">
                            <div class="grid grid-cols-[1fr_1fr_auto] gap-2">
                                <input type="text" name="structured_keys[]" x-model="pair.key" placeholder="key"
                                       class="input-dense bg-gray-900 w-full">
                                <input type="text" name="structured_values[]" x-model="pair.value" placeholder="value"
                                       class="input-dense bg-gray-900 w-full">
                                <button type="button" class="btn px-3 py-1" @click="removeStructuredPair(index)">Remove</button>
                            </div>
                        </template>
                        <button type="button" class="btn px-3 py-1 text-xs" @click="addStructuredPair()">Add Field</button>
                    </div>
                </div>

                <div class="border border-gray-300 rounded bg-gray-100">
                    <button type="button" class="w-full flex items-center justify-between px-3 py-2 text-xs text-black font-medium hover:bg-gray-200"
                            @click="evaluationOpen = !evaluationOpen">
                        <span>Evaluation Data</span>
                        <span x-text="evaluationOpen ? '-' : '+'"></span>
                    </button>
                    <div x-show="evaluationOpen" x-cloak class="px-3 pb-3 space-y-2">
                        <template x-for="(pair, index) in evaluationPairs" :key="'evaluation-' + index">
                            <div class="grid grid-cols-[1fr_1fr_auto] gap-2">
                                <input type="text" name="evaluation_keys[]" x-model="pair.key" placeholder="key"
                                       class="input-dense bg-gray-900 w-full">
                                <input type="text" name="evaluation_values[]" x-model="pair.value" placeholder="value"
                                       class="input-dense bg-gray-900 w-full">
                                <button type="button" class="btn px-3 py-1" @click="removeEvaluationPair(index)">Remove</button>
                            </div>
                        </template>
                        <button type="button" class="btn px-3 py-1 text-xs" @click="addEvaluationPair()">Add Field</button>
                    </div>
                </div>

                <div class="border border-gray-300 rounded bg-gray-100">
                    <button type="button" class="w-full flex items-center justify-between px-3 py-2 text-xs text-black font-medium hover:bg-gray-200"
                            @click="entityOpen = !entityOpen">
                        <span>Entity IDs</span>
                        <span x-text="entityOpen ? '-' : '+'"></span>
                    </button>
                    <div x-show="entityOpen" x-cloak class="px-3 pb-3">
                        <input type="text" name="entity_ids" placeholder="uuid1, uuid2, uuid3"
                               class="input-dense bg-gray-900 w-full">
                    </div>
                </div>
            </div>
        </form>
        <div id="submit-status" class="text-[10px] mt-1"></div>
    </div>

    <!-- Queue Panel -->
    <div id="queue-panel" class="bg-gray-800 border border-gray-700 rounded overflow-hidden"
         style="display: none;">
        <div class="flex justify-between items-center px-2 py-1 border-b border-gray-700 cursor-pointer"
             onclick="toggleQueuePanel()">
            <span class="text-xs font-bold text-secondary uppercase">Queue (<span id="queue-count">0</span>)</span>
            <span id="queue-toggle" class="text-secondary text-xs">&#x25BC;</span>
        </div>
        <div id="queue-body" class="max-h-64 overflow-auto">
            <table class="dense-table">
                <thead class="sticky top-0 bg-sidebar">
                    <tr>
                        <th class="w-32">Event ID</th>
                        <th class="w-24">Source</th>
                        <th>Text</th>
                        <th class="w-24">Salience</th>
                        <th class="w-24">Age</th>
                    </tr>
                </thead>
                <tbody id="queue-table-body"></tbody>
            </table>
        </div>
    </div>

    {{ bulk_action_bar('events-bulk-action-bar', 'events-selected-count', 'bulkDeleteEvents()') }}

    <!-- Event List (Div-based) -->
    <div class="flex-1 overflow-auto border border-gray-700 rounded bg-gray-900">
        <!-- Header -->
        <div class="sticky top-0 z-10 bg-gray-800 shadow-md">
            <!-- Column Headers -->
            <div class="grid grid-cols-[30px_90px_70px_50px_1fr_80px_70px] gap-4 px-4 py-2 text-xs font-medium text-gray-400 uppercase tracking-wider border-b border-gray-700">
                <div class="flex items-center">
                    <input type="checkbox" onclick="toggleSelectAllEvents()" class="rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-0 focus:ring-offset-0">
                </div>
                <div>Time</div>
                <div>Source</div>
                <div>Intent</div>
                <div>Event</div>
                <div>Status</div>
                <div>Path</div>
            </div>
            <!-- Filter Row -->
            <div class="grid grid-cols-[30px_90px_70px_50px_1fr_80px_70px] gap-4 px-4 py-1 bg-gray-850 border-b border-gray-700">
                <div></div>
                <div></div>
                <div>
                    <input type="text" class="input-dense text-[10px] w-full" placeholder="Filter..." data-filter-col="source" data-filter-mode="contains">
                </div>
                <div>
                    <select class="input-dense text-[10px] w-full" data-filter-col="intent" data-filter-mode="equals">
                        <option value="">All</option>
                        <option value="actionable">Actionable</option>
                        <option value="informational">Informational</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>
                <div>
                    <input type="text" class="input-dense text-[10px] w-full" placeholder="Filter event..." data-filter-col="event" data-filter-mode="contains">
                </div>
                <div>
                    <select class="input-dense text-[10px] w-full" data-filter-col="status" data-filter-mode="equals">
                        <option value="">All</option>
                        <option value="queued">Queued</option>
                        <option value="processing">Processing</option>
                        <option value="responded">Responded</option>
                    </select>
                </div>
                <div>
                    <select class="input-dense text-[10px] w-full" data-filter-col="path" data-filter-mode="equals">
                        <option value="">All</option>
                        <option value="heuristic">Heuristic</option>
                        <option value="llm">LLM</option>
                        <option value="fallback">Fallback</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Event Rows Container (SSE target) -->
        <div id="event-table-body"
             hx-ext="sse"
             sse-connect="/api/events/stream"
             sse-swap="message"
             hx-swap="afterbegin">
            {% for event in initial_events %}
                {% include 'components/event_row.html' %}
            {% endfor %}
        </div>
    </div>

    <!-- Load More -->
    <div class="flex justify-center gap-4 p-2">
        <button id="load-more-btn"
                hx-get="/api/events/rows?offset=25&limit=25"
                hx-target="#event-table-body"
                hx-swap="beforeend"
                hx-on::after-request="this.setAttribute('hx-get',
                    '/api/events/rows?offset=' + (parseInt(this.dataset.offset || 25) + 25) + '&limit=25');
                    this.dataset.offset = parseInt(this.dataset.offset || 25) + 25;
                    htmx.process(this);"
                data-offset="25"
                class="btn text-xs text-secondary">Load more&hellip;</button>
    </div>
</div>

<script>
// Events selection state (inline, like Response tab)
window.eventsSelection = {
    selected: new Set(),
    toggle(id) {
        if (this.selected.has(id)) {
            this.selected.delete(id);
        } else {
            this.selected.add(id);
        }
        this.updateUI();
    },
    isSelected(id) {
        return this.selected.has(id);
    },
    clear() {
        this.selected.clear();
        this.updateUI();
    },
    getSelected() {
        return [...this.selected];
    },
    updateUI() {
        const bar = document.getElementById('events-bulk-action-bar');
        const count = document.getElementById('events-selected-count');
        if (this.selected.size > 0) {
            if (bar) bar.style.display = '';
            if (count) count.textContent = this.selected.size;
        } else {
            if (bar) bar.style.display = 'none';
        }
    }
};

function toggleSelectAllEvents() {
    const container = document.getElementById('event-table-body');
    if (!container) return;
    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
    const allSelected = checkboxes.length > 0 && [...checkboxes].every(cb => cb.checked);
    checkboxes.forEach(cb => {
        cb.checked = !allSelected;
        const id = cb.value;
        if (!allSelected) {
            window.eventsSelection.selected.add(id);
        } else {
            window.eventsSelection.selected.delete(id);
        }
    });
    window.eventsSelection.updateUI();
}
</script>

<script>
(function() {
    const filterContainer = document.querySelector('#lab-tab .bg-gray-850');
    if (!filterContainer) return;

    const inputs = filterContainer.querySelectorAll('input, select');
    inputs.forEach(el => el.addEventListener('input', applyEventFilters));
    inputs.forEach(el => el.addEventListener('change', applyEventFilters));

    function applyEventFilters() {
        const filters = {};
        filterContainer.querySelectorAll('[data-filter-col]').forEach(el => {
            const col = el.dataset.filterCol;
            const mode = el.dataset.filterMode || 'contains';
            const val = el.value.trim().toLowerCase();
            if (val) filters[col] = { mode, val };
        });

        const container = document.getElementById('event-table-body');
        if (!container) return;

        const rows = container.querySelectorAll(':scope > div');

        for (const row of rows) {
            const grid = row.querySelector('.parent-row');
            if (!grid) continue;

            const cells = grid.children;
            let visible = true;

            // Map columns by index: 0=checkbox, 1=time, 2=source, 3=intent, 4=event, 5=status, 6=path
            const colMap = { 'source': 2, 'intent': 3, 'event': 4, 'status': 5, 'path': 6 };

            for (const [col, filter] of Object.entries(filters)) {
                if (col === 'time-after' || col === 'time-before') continue;
                const idx = colMap[col];
                if (idx === undefined || !cells[idx]) continue;
                const text = col === 'intent'
                    ? ((cells[idx].dataset.intent || '').trim().toLowerCase())
                    : ((cells[idx].textContent || '').trim().toLowerCase());
                if (filter.mode === 'equals' && text !== filter.val) { visible = false; break; }
                if (filter.mode === 'contains' && !text.includes(filter.val)) { visible = false; break; }
            }
            row.style.display = visible ? '' : 'none';
        }
    }

    window.deleteEvent = async function(eventId) {
        try {
            const res = await fetch(`/api/events/${eventId}`, { method: 'DELETE' });
            if (res.ok) {
                const rows = document.querySelectorAll('#event-table-body > div');
                for (const row of rows) {
                    if (row.innerHTML.includes(eventId)) { row.remove(); break; }
                }
                window.eventsSelection?.selected.delete(eventId);
                window.eventsSelection?.updateUI();
            } else { alert('Delete failed'); }
        } catch (e) { alert('Delete failed: ' + e); }
    };
})();

async function bulkDeleteEvents() {
    const ids = window.eventsSelection.getSelected();
    if (!confirm(`Delete ${ids.length} events?`)) return;
    try {
        const res = await fetch('/api/events', { method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({event_ids: ids}) });
        if (res.ok) {
            window.eventsSelection.clear();
            ids.forEach(id => {
                const rows = document.querySelectorAll('#event-table-body > div');
                for (const row of rows) {
                    if (row.innerHTML.includes(id)) { row.remove(); break; }
                }
            });
        } else {
            const data = await res.json();
            alert(`Delete failed: ${data.detail || 'Unknown error'}`);
        }
    } catch (e) { alert('Delete failed: ' + e); }
}
</script>
