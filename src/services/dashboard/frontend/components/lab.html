<div id="lab-tab" class="flex flex-col h-full gap-4">
    <!-- Event Submission Bar -->
    <div class="bg-gray-800 p-2 border border-gray-700 rounded sticky top-0 z-10">
        <form hx-post="/api/events" hx-target="#submit-status" hx-swap="innerHTML"
              hx-on::after-request="if(event.detail.successful) { var s=document.getElementById('submit-status'); var el=s&&s.querySelector('[data-event-id]'); if(el) addPendingEvent(el.dataset.eventId, el.dataset.source, el.dataset.text); this.querySelector('[name=text]').value=''; if(typeof boostQueuePolling==='function') boostQueuePolling(); if(typeof clearStatusAfterDelay==='function') clearStatusAfterDelay(); }"
              class="flex gap-2 items-center">
            <select name="source" class="input-dense bg-gray-900 w-32">
                <option value="sudoku">sudoku</option>
                <option value="melvor">melvor</option>
                <option value="minecraft">minecraft</option>
                <option value="kitchen">kitchen</option>
                <option value="smart_home">smart_home</option>
                <option value="work">work</option>
                <option value="health">health</option>
                <option value="custom">custom...</option>
            </select>
            <input type="text" name="text" placeholder="Enter event text..." required class="input-dense bg-gray-900 flex-1">
            <select name="salience_override" class="input-dense bg-gray-900 w-32">
                <option value="">System (Auto)</option>
                <option value="high">Force HIGH</option>
                <option value="low">Force LOW</option>
            </select>
            <button type="submit" class="btn btn-primary px-4 py-1">Submit</button>
            <button type="button" onclick="document.getElementById('batch-file').click()"
                    class="btn px-4 py-1" title="Load events from a JSON file">Load JSON</button>
            <input type="file" id="batch-file" accept=".json" class="hidden"
                   onchange="uploadBatchFile(this)" style="display:none">
        </form>
        <div id="submit-status" class="text-[10px] mt-1"></div>
    </div>

    <!-- Queue Panel -->
    <div id="queue-panel" class="bg-gray-800 border border-gray-700 rounded overflow-hidden"
         style="display: none;">
        <div class="flex justify-between items-center px-2 py-1 border-b border-gray-700 cursor-pointer"
             onclick="toggleQueuePanel()">
            <span class="text-xs font-bold text-secondary uppercase">Queue (<span id="queue-count">0</span>)</span>
            <span id="queue-toggle" class="text-secondary text-xs">&#x25BC;</span>
        </div>
        <div id="queue-body" class="max-h-64 overflow-auto">
            <table class="dense-table">
                <thead class="sticky top-0 bg-sidebar">
                    <tr>
                        <th class="w-32">Event ID</th>
                        <th class="w-24">Source</th>
                        <th>Text</th>
                        <th class="w-24">Salience</th>
                        <th class="w-24">Age</th>
                    </tr>
                </thead>
                <tbody id="queue-table-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Unified Event Table -->
    <div class="flex-1 overflow-auto border border-gray-700 rounded bg-gray-900">
        <table class="dense-table">
            <thead class="sticky top-0 z-10 bg-sidebar shadow-md">
                <tr>
                    <th class="w-32 align-bottom pb-1">
                        Time <div class="col-resizer" @mousedown.prevent="resizeColumn"></div>
                    </th>
                    <th class="w-24 align-bottom pb-1">
                        Source <div class="col-resizer" @mousedown.prevent="resizeColumn"></div>
                    </th>
                    <th class="align-bottom pb-1">
                        Event <div class="col-resizer" @mousedown.prevent="resizeColumn"></div>
                    </th>
                    <th class="w-24 align-bottom pb-1">
                        Status <div class="col-resizer" @mousedown.prevent="resizeColumn"></div>
                    </th>
                    <th class="w-24 align-bottom pb-1">
                        Path <div class="col-resizer" @mousedown.prevent="resizeColumn"></div>
                    </th>
                    <th class="align-bottom pb-1">
                        Response
                    </th>
                </tr>
                <!-- Filter Row -->
                <tr class="bg-gray-800 border-b border-gray-700">
                    <td class="p-1">
                        <div class="flex flex-col gap-1">
                            <input type="datetime-local" class="input-dense text-[10px] w-full" placeholder="After...">
                            <input type="datetime-local" class="input-dense text-[10px] w-full" placeholder="Before...">
                        </div>
                    </td>
                    <td class="p-1">
                        <input type="text" class="input-dense text-[10px] w-full" placeholder="Filter source..." data-filter-mode="contains">
                    </td>
                    <td class="p-1">
                        <input type="text" class="input-dense text-[10px] w-full" placeholder="Filter event..." data-filter-mode="contains">
                    </td>
                    <td class="p-1">
                        <select class="input-dense text-[10px] w-full" data-filter-mode="equals">
                            <option value="">All</option>
                            <option value="pending">Pending</option>
                            <option value="processed">Processed</option>
                            <option value="error">Error</option>
                            <option value="timeout">Timeout</option>
                        </select>
                    </td>
                    <td class="p-1">
                        <select class="input-dense text-[10px] w-full" data-filter-mode="equals">
                            <option value="">All</option>
                            <option value="heuristic">Heuristic</option>
                            <option value="llm">LLM</option>
                            <option value="none">None</option>
                        </select>
                    </td>
                    <td class="p-1">
                        <input type="text" class="input-dense text-[10px] w-full" placeholder="Filter response..." data-filter-mode="contains">
                    </td>
                </tr>
            </thead>
            <tbody id="event-table-body"
                   hx-ext="sse"
                   sse-connect="/api/events/stream"
                   sse-swap="message"
                   hx-swap="afterbegin">
                {% for event in initial_events %}
                    {% include 'components/event_row.html' %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Load More / Clear -->
    <div class="flex justify-center gap-4 p-2">
        <button id="load-more-btn"
                hx-get="/api/events/rows?offset=25&limit=25"
                hx-target="#event-table-body"
                hx-swap="beforeend"
                hx-on::after-request="this.setAttribute('hx-get',
                    '/api/events/rows?offset=' + (parseInt(this.dataset.offset || 25) + 25) + '&limit=25');
                    this.dataset.offset = parseInt(this.dataset.offset || 25) + 25;
                    htmx.process(this);"
                data-offset="25"
                class="btn text-xs text-secondary">Load more&hellip;</button>
        <button onclick="clearAllEvents()"
                class="btn text-xs text-red-400 hover:text-red-200">Clear all</button>
    </div>
</div>

<script>
(function() {
    const filterRow = document.querySelector('#lab-tab thead tr.bg-gray-800');
    if (!filterRow) return;

    const inputs = filterRow.querySelectorAll('input, select');
    inputs.forEach(el => el.addEventListener('input', applyEventFilters));
    inputs.forEach(el => el.addEventListener('change', applyEventFilters));

    function applyEventFilters() {
        const cells = filterRow.querySelectorAll('td');
        const filters = [];
        cells.forEach(td => {
            const inp = td.querySelector('input[type="text"], select');
            const mode = inp ? (inp.dataset.filterMode || 'contains') : 'contains';
            const val = inp ? inp.value.trim().toLowerCase() : '';
            filters.push({ mode, val });
        });

        const tbody = document.getElementById('event-table-body');
        if (!tbody) return;
        const rows = tbody.querySelectorAll('tr');

        for (const row of rows) {
            // Detail rows (id starts with "detail-") follow their parent's visibility
            if (row.id && row.id.startsWith('detail-')) continue;

            const tds = row.querySelectorAll('td');
            let visible = true;
            for (let i = 0; i < filters.length && i < tds.length; i++) {
                const f = filters[i];
                if (!f.val) continue;
                const text = (tds[i].textContent || '').trim().toLowerCase();
                if (f.mode === 'equals' && text !== f.val) { visible = false; break; }
                if (f.mode === 'contains' && !text.includes(f.val)) { visible = false; break; }
            }
            row.style.display = visible ? '' : 'none';
            // Hide associated detail row when parent is hidden
            const detailRow = row.id ? document.getElementById('detail-' + row.id.replace('event-', '')) : null;
            if (detailRow && !visible) detailRow.style.display = 'none';
        }
    }
})();
</script>
