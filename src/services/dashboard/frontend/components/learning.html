<div id="learning-tab" class="h-full flex flex-col"
     x-data="learningToolbar()"
     x-init="checkPending()"
     @tab-filter-update.window="handleTabSwitch">

    <!-- Toolbar (Alpine for filter state, triggers htmx refresh) -->
    <div class="flex items-center gap-4 p-4 border-b border-gray-700 bg-gray-900">
        <h2 class="text-xs font-bold text-secondary uppercase tracking-widest">Flight Recorder</h2>
        <div class="h-4 w-px bg-gray-700"></div>

        <select x-model="filterOutcome"
                @change="refresh()"
                class="bg-gray-800 border border-gray-600 rounded px-2 py-1 text-sm text-gray-200 focus:outline-none focus:border-blue-500">
            <option value="all">All Outcomes</option>
            <option value="success">Success</option>
            <option value="failure">Failure</option>
            <option value="unknown">Pending</option>
        </select>

        <div class="relative flex-1 max-w-md">
            <input type="text" x-model="searchQuery"
                   @input.debounce.300ms="refresh()"
                   placeholder="Search heuristic or event..."
                   class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-1 pl-8 text-sm text-gray-200 focus:outline-none focus:border-blue-500">
            <svg class="w-4 h-4 absolute left-2 top-1.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
        </div>

        <button @click="refresh()" class="text-gray-400 hover:text-white" title="Refresh">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
        </button>
    </div>

    <!-- Header -->
    <div class="grid grid-cols-[20px_100px_1fr_1fr_80px_80px_80px] gap-4 px-4 py-2 bg-gray-800 text-xs font-medium text-gray-400 uppercase tracking-wider border-b border-gray-700">
        <div></div>
        <div>Time</div>
        <div>Heuristic</div>
        <div>Condition</div>
        <div>Outcome</div>
        <div>Source</div>
        <div>Conf</div>
    </div>

    <!-- Rows (htmx loads, server renders) -->
    <div id="fires-list" class="flex-1 overflow-y-auto"
         hx-get="/api/fires/rows"
         hx-trigger="load"
         hx-swap="innerHTML">
        <div class="p-8 text-center text-gray-500">Loading fires...</div>
    </div>
</div>

<script>
function learningToolbar() {
    return {
        filterOutcome: 'all',
        searchQuery: '',

        refresh() {
            const params = new URLSearchParams();
            if (this.filterOutcome !== 'all') params.set('outcome', this.filterOutcome);
            if (this.searchQuery) params.set('search', this.searchQuery);
            const url = '/api/fires/rows' + (params.toString() ? '?' + params.toString() : '');
            htmx.ajax('GET', url, {target: '#fires-list'});
        },

        handleTabSwitch(e) {
            if (e.detail.tab === 'learning') {
                if (e.detail.filter === 'heuristic_id') {
                    this.searchQuery = e.detail.value;
                    this.filterOutcome = 'all';
                    this.refresh();
                }
            }
        },

        checkPending() {
            if (window.pendingTabFilter && window.pendingTabFilter.tab === 'learning') {
                this.handleTabSwitch({ detail: window.pendingTabFilter });
                window.pendingTabFilter = null;
            }
        }
    };
}
</script>
