<div id="knowledge-tab" class="flex flex-col gap-6" x-data="{
    heuristics: [],
    probeResults: [],
    loading: false,
    probeLoading: false,
    newFormOpen: false,
    probeText: '',
    filterOrigin: 'all',
    filterActive: 'all',
    filterName: '',
    newHeuristic: { name: '', condition_text: '', effects_json: '{}', confidence: 0.8, origin: 'user', active: true },

    get filteredHeuristics() {
        return this.heuristics.filter(h => {
            if (this.filterOrigin !== 'all' && h.origin !== this.filterOrigin) return false;
            if (this.filterActive === 'active' && !h.active) return false;
            if (this.filterActive === 'inactive' && h.active) return false;
            if (this.filterName && !h.name.toLowerCase().includes(this.filterName.toLowerCase()) && !h.condition_text.toLowerCase().includes(this.filterName.toLowerCase())) return false;
            return true;
        });
    },
    
    async fetchHeuristics() {
        this.loading = true;
        try {
            const resp = await fetch('/api/heuristics');
            const data = await resp.json();
            this.heuristics = data.heuristics || [];
        } catch (e) {
            console.error('Failed to fetch heuristics:', e);
        } finally {
            this.loading = false;
        }
    },
    
    async saveHeuristic(h) {
        const isNew = !h.id;
        const url = isNew ? '/api/heuristics' : `/api/heuristics/${h.id}`;
        const method = isNew ? 'POST' : 'PUT';
        
        try {
            const resp = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(h)
            });
            if (resp.ok) {
                this.fetchHeuristics();
                if (isNew) {
                    this.newFormOpen = false;
                    this.newHeuristic = { name: '', condition_text: '', effects_json: '{}', confidence: 0.8, origin: 'user', active: true };
                }
            }
        } catch (e) {
            console.error('Failed to save heuristic:', e);
        }
    },
    
    async deleteHeuristic(id) {
        if (!confirm('Are you sure you want to delete this heuristic?')) return;
        try {
            const resp = await fetch(`/api/heuristics/${id}`, { method: 'DELETE' });
            if (resp.ok) this.fetchHeuristics();
        } catch (e) {
            console.error('Failed to delete heuristic:', e);
        }
    },
    
    async probe() {
        if (!this.probeText) return;
        this.probeLoading = true;
        try {
            const resp = await fetch('/api/memory/probe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: this.probeText })
            });
            const data = await resp.json();
            this.probeResults = data.results || [];
        } catch (e) {
            console.error('Probe failed:', e);
        } finally {
            this.probeLoading = false;
        }
    }
}" x-init="fetchHeuristics()" @refresh-knowledge.window="fetchHeuristics()">

    <!-- Header & Actions -->
    <div class="flex flex-col gap-2 mb-2">
        <h2 class="text-sm font-bold text-secondary uppercase tracking-wider text-center">Learned Knowledge Base</h2>
        <div class="flex items-center gap-2">
            <button @click="newFormOpen = !newFormOpen" class="btn btn-primary px-3 py-1 flex items-center justify-center gap-2">
                <span x-text="newFormOpen ? '‚úï Cancel' : '+ New Heuristic'"></span>
            </button>
            <div class="flex-1"></div>
            <div class="flex items-center gap-3">
                <input type="text" x-model="filterName" placeholder="Search name/condition..." class="input-dense bg-gray-900 w-48 text-[11px]">
                <select x-model="filterOrigin" class="input-dense bg-gray-900 text-[11px]">
                    <option value="all">All Origins</option>
                    <option value="user">User</option>
                    <option value="learned">Learned</option>
                    <option value="built_in">Built-in</option>
                </select>
                <select x-model="filterActive" class="input-dense bg-gray-900 text-[11px]">
                    <option value="all">All Status</option>
                    <option value="active">Active Only</option>
                    <option value="inactive">Inactive Only</option>
                </select>
            </div>
        </div>
    </div>

    <!-- New Heuristic Form -->
    <div x-show="newFormOpen" x-transition class="bg-gray-800 p-4 border border-gray-700 rounded shadow-lg">
        <h3 class="text-xs font-bold text-secondary uppercase mb-3">Create New Heuristic</h3>
        <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col gap-2">
                <label class="text-[10px] text-secondary uppercase">Name</label>
                <input type="text" x-model="newHeuristic.name" class="input-dense bg-gray-900" placeholder="e.g., greet-user">
                
                <label class="text-[10px] text-secondary uppercase mt-2">Condition Text</label>
                <textarea x-model="newHeuristic.condition_text" class="input-dense bg-gray-900 h-20" placeholder="The natural language pattern to match..."></textarea>
            </div>
            <div class="flex flex-col gap-2">
                <label class="text-[10px] text-secondary uppercase">Action JSON</label>
                <textarea x-model="newHeuristic.effects_json" class="input-dense bg-gray-900 h-20 font-mono text-[11px]" placeholder='{"response": "Hello!"}'></textarea>
                
                <div class="flex gap-4 mt-2">
                    <div class="flex-1">
                        <label class="text-[10px] text-secondary uppercase">Confidence</label>
                        <input type="range" x-model="newHeuristic.confidence" min="0" max="1" step="0.05" class="w-full">
                        <div class="text-[10px] text-right" x-text="newHeuristic.confidence"></div>
                    </div>
                    <div class="w-32">
                        <label class="text-[10px] text-secondary uppercase">Origin</label>
                        <select x-model="newHeuristic.origin" class="input-dense bg-gray-900 w-full">
                            <option value="user">User</option>
                            <option value="built_in">Built-in</option>
                            <option value="learned">Learned</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-4 flex justify-end">
            <button @click="saveHeuristic(newHeuristic)" class="btn btn-primary px-6 py-1">Save Heuristic</button>
        </div>
    </div>

    <!-- Heuristics Table -->
    <div class="bg-gray-900 border border-gray-700 rounded overflow-hidden">
        <table class="dense-table w-full">
            <thead class="bg-gray-800">
                <tr>
                    <th class="w-48">Name</th>
                    <th>Condition</th>
                    <th class="w-24 text-center">Confidence</th>
                    <th class="w-24 text-center">Origin</th>
                    <th class="w-20 text-center">Active</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="h in filteredHeuristics" :key="h.id">
                    <template x-data="{ expanded: false }">
                        <tbody class="border-b border-gray-800 last:border-0">
                            <tr @click="expanded = !expanded" class="cursor-pointer hover:bg-gray-800 transition-colors" :class="expanded ? 'bg-gray-800' : ''">
                                <td class="font-bold py-2">
                                    <span x-text="h.name"></span>
                                    <span class="text-[9px] font-mono text-secondary ml-1" x-text="h.id ? h.id.substring(0, 8) : ''"></span>
                                </td>
                                <td class="text-secondary truncate max-w-md" x-text="h.condition_text"></td>
                                <td class="text-center">
                                    <div class="w-full bg-gray-700 h-1.5 rounded-full overflow-hidden">
                                        <div class="bg-blue-500 h-full" :style="`width: ${h.confidence * 100}%`"></div>
                                    </div>
                                    <span class="text-[10px] text-secondary" x-text="Math.round(h.confidence * 100) + '%'"></span>
                                </td>
                                <td class="text-center">
                                    <span class="px-1.5 py-0.5 rounded text-[10px] uppercase font-bold bg-gray-700 text-gray-300" x-text="h.origin"></span>
                                </td>
                                <td class="text-center">
                                    <span class="service-dot" :class="h.active ? 'dot-green' : 'dot-gray'"></span>
                                </td>
                            </tr>
                            <tr x-show="expanded" class="bg-gray-800/50">
                                <td colspan="5" class="p-4 border-t border-gray-700">
                                    <div class="grid grid-cols-2 gap-6">
                                        <div class="flex flex-col gap-3">
                                            <div>
                                                <label class="text-[10px] text-secondary uppercase font-bold">Edit Condition</label>
                                                <textarea x-model="h.condition_text" class="input-dense bg-gray-900 w-full h-24 mt-1" @click.stop></textarea>
                                            </div>
                                            <div class="flex gap-4">
                                                <div class="flex-1">
                                                    <label class="text-[10px] text-secondary uppercase font-bold">Confidence Override</label>
                                                    <input type="range" x-model="h.confidence" min="0" max="1" step="0.01" class="w-full mt-1" @click.stop>
                                                </div>
                                                <div class="flex items-center gap-2 mt-4">
                                                    <input type="checkbox" x-model="h.active" @click.stop>
                                                    <span class="text-[10px] text-secondary uppercase font-bold">Active</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-3">
                                            <div>
                                                <label class="text-[10px] text-secondary uppercase font-bold">Action JSON</label>
                                                <textarea x-model="h.effects_json" class="input-dense bg-gray-900 w-full h-24 mt-1 font-mono text-[11px]" @click.stop></textarea>
                                            </div>
                                            <div class="flex justify-between items-end mt-2">
                                                <button @click.stop="deleteHeuristic(h.id)" class="btn text-red-400 border-red-900 hover:bg-red-900/30">Delete Rule</button>
                                                <div class="flex gap-2">
                                                    <button @click.stop="expanded = false" class="btn">Close</button>
                                                    <button @click.stop="saveHeuristic(h)" class="btn btn-primary px-4">Save Changes</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </template>
                </template>
                <tr x-show="filteredHeuristics.length === 0 && !loading">
                    <td colspan="5" class="p-8 text-center text-secondary italic">No heuristics found. Click + New Heuristic to create one.</td>
                </tr>
                <tr x-show="loading">
                    <td colspan="5" class="p-8 text-center text-secondary animate-pulse">Loading knowledge base...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Similarity Probe -->
    <div class="bg-gray-800 p-4 border border-gray-700 rounded shadow-md">
        <h2 class="text-xs font-bold text-secondary uppercase mb-3 tracking-widest">Memory Similarity Probe</h2>
        <div class="flex gap-2 mb-4">
            <input type="text" x-model="probeText" @keyup.enter="probe()" class="input-dense bg-gray-900 flex-1" placeholder="Type a message to find similar heuristics in memory...">
            <button @click="probe()" class="btn btn-primary px-4 py-1" :disabled="probeLoading">
                <span x-show="!probeLoading">üîç Probe</span>
                <span x-show="probeLoading">...</span>
            </button>
        </div>

        <div x-show="probeResults.length > 0" class="space-y-2 max-h-64 overflow-auto pr-2">
            <template x-for="res in probeResults" :key="res.id">
                <div class="bg-gray-900 p-2 border-l-2 border-blue-500 rounded flex justify-between items-center gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-xs" x-text="res.name"></span>
                            <span class="text-[10px] bg-gray-800 px-1 rounded text-secondary" x-text="`Similarity: ${res.similarity.toFixed(3)}`"></span>
                        </div>
                        <div class="text-[11px] text-secondary truncate" x-text="res.condition_text"></div>
                    </div>
                    <span class="text-[10px] font-mono text-blue-400 bg-blue-900/20 px-2 py-1 rounded" x-text="res.confidence.toFixed(2)"></span>
                </div>
            </template>
        </div>
        <div x-show="probeResults.length === 0 && !probeLoading && probeText" class="text-center p-4 text-secondary text-[11px] italic">
            No matching heuristics found for this query.
        </div>
    </div>
</div>