{% from 'components/widgets/data_table.html' import toolbar, bulk_action_bar, column_headers, rows_container %}
<div id="heuristics-tab" class="h-full flex flex-col" x-data="{
    filterOrigin: '', filterActive: 'all', searchQuery: '', showNewForm: false, creating: false,
    refresh() { const p = new URLSearchParams(); if (this.filterOrigin) p.set('origin', this.filterOrigin); if (this.filterActive !== 'all') p.set('active', this.filterActive); if (this.searchQuery) p.set('search', this.searchQuery); htmx.ajax('GET', '/api/heuristics/rows' + (p.toString() ? '?' + p : ''), {target: '#heuristics-list'}); },
    async createHeuristic(form) { if (this.creating) return; this.creating = true; try { const r = await fetch('/api/heuristics/create', {method:'POST', body: new FormData(form)}); if (r.ok) { document.getElementById('heuristics-list').innerHTML = await r.text(); this.showNewForm = false; form.reset(); } else alert('Failed'); } catch(e) { alert(e); } finally { this.creating = false; } },
    handleTabSwitch(e) { if (e.detail?.tab === 'heuristics' && e.detail.filter === 'id') { this.searchQuery = e.detail.value; this.filterOrigin = ''; this.filterActive = 'all'; this.refresh(); } },
    checkPending() { if (window.pendingTabFilter?.tab === 'heuristics') { this.handleTabSwitch({detail: window.pendingTabFilter}); window.pendingTabFilter = null; } }
}" x-init="checkPending()" @tab-filter-update.window="handleTabSwitch($event)">

    {{ toolbar('+ New Heuristic', 'showNewForm = !showNewForm', 'refresh()') }}

    {% include 'components/heuristics_form.html' %}

    {{ bulk_action_bar('bulk-action-bar', 'selected-count', 'bulkDeleteHeuristics()') }}

    {{ column_headers('grid-cols-[30px_80px_1fr_60px]', [
        {'filter_type': 'checkbox', 'select_all_fn': 'toggleSelectAll()', 'label': ''},
        {'filter_type': 'select', 'filter_model': 'filterOrigin', 'on_change': 'refresh()',
         'filter_options': [{'value': '', 'label': 'All'}, {'value': 'learned', 'label': 'Learned'}, {'value': 'user', 'label': 'User'}, {'value': 'built_in', 'label': 'Built-in'}],
         'label': 'Origin'},
        {'filter_type': 'search', 'filter_model': 'searchQuery', 'on_change': 'refresh()', 'filter_placeholder': 'Search condition...', 'label': 'Condition'},
        {'filter_type': 'select', 'filter_model': 'filterActive', 'on_change': 'refresh()',
         'filter_options': [{'value': 'all', 'label': 'All'}, {'value': 'active', 'label': 'On'}, {'value': 'inactive', 'label': 'Off'}],
         'label': 'Active'}
    ]) }}

    {{ rows_container('heuristics-list', '/api/heuristics/rows', 'Loading heuristics...') }}
</div>

<script>
// Heuristics selection state (inline, like Response tab)
window.heuristicsSelection = {
    selected: new Set(),
    toggle(id) {
        if (this.selected.has(id)) {
            this.selected.delete(id);
        } else {
            this.selected.add(id);
        }
        this.updateUI();
    },
    isSelected(id) {
        return this.selected.has(id);
    },
    clear() {
        this.selected.clear();
        this.updateUI();
    },
    getSelected() {
        return [...this.selected];
    },
    updateUI() {
        const bar = document.getElementById('bulk-action-bar');
        const count = document.getElementById('selected-count');
        if (this.selected.size > 0) {
            if (bar) bar.style.display = '';
            if (count) count.textContent = this.selected.size;
        } else {
            if (bar) bar.style.display = 'none';
        }
    }
};

function toggleSelectAll() {
    const container = document.getElementById('heuristics-list');
    if (!container) return;
    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
    const allSelected = checkboxes.length > 0 && [...checkboxes].every(cb => cb.checked);
    checkboxes.forEach(cb => {
        cb.checked = !allSelected;
        const id = cb.value;
        if (!allSelected) {
            window.heuristicsSelection.selected.add(id);
        } else {
            window.heuristicsSelection.selected.delete(id);
        }
    });
    window.heuristicsSelection.updateUI();
}

async function bulkDeleteHeuristics() {
    const ids = window.heuristicsSelection.getSelected();
    if (!confirm(`Delete ${ids.length} heuristics?`)) return;
    try {
        const res = await fetch('/api/heuristics', { method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ids}) });
        if (res.ok) { window.heuristicsSelection.clear(); htmx.ajax('GET', '/api/heuristics/rows', {target: '#heuristics-list'}); }
        else { const data = await res.json(); if (data.errors?.length) alert(`Some deletions failed: ${data.errors.map(e => e.error).join(', ')}`); }
    } catch (e) { alert('Delete failed: ' + e); }
}

async function deleteHeuristic(id) {
    try {
        const res = await fetch(`/api/heuristics/${id}`, { method: 'DELETE' });
        if (res.ok) htmx.ajax('GET', '/api/heuristics/rows', {target: '#heuristics-list'});
        else alert('Delete failed');
    } catch (e) { alert('Delete failed: ' + e); }
}

async function saveHeuristicFull(id, origin, conditionText, responseText, confidence) {
    const effectsJson = JSON.stringify({ action: "respond", message: responseText });
    try {
        const res = await fetch(`/api/heuristics/${id}`, {
            method: 'PUT', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ origin, condition_text: conditionText, effects_json: effectsJson, confidence: parseFloat(confidence) })
        });
        if (!res.ok) { alert('Save failed'); throw new Error('Save failed'); }
    } catch (e) { alert('Save failed: ' + e); throw e; }
}

async function toggleActive(id, currentState) {
    try {
        const res = await fetch(`/api/heuristics/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ active: !currentState }) });
        if (res.ok) htmx.ajax('GET', '/api/heuristics/rows', {target: '#heuristics-list'});
        else alert('Toggle failed');
    } catch (e) { alert('Toggle failed: ' + e); }
}
</script>
