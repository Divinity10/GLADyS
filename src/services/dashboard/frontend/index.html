<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLADyS Dashboard V2</title>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/sse.js"></script>
    <!-- Alpine.js + Collapse plugin (plugin must load first) -->
    <script defer src="https://unpkg.com/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Styles -->
    <link rel="stylesheet" href="/css/style.css?v=13">
</head>
<body class="bg-dark text-light font-mono overflow-hidden h-screen flex flex-col" x-data="appState()">
    <!-- Metrics Strip -->
    <header id="metrics-strip" 
            hx-get="/api/metrics" 
            hx-trigger="load, every 30s" 
            hx-swap="innerHTML">
        <div class="p-2 border-b border-gray-700 text-xs flex gap-4 justify-center w-full">
            Loading metrics...
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden w-full" 
         x-data="{ 
             sidebarWidth: parseInt(localStorage.getItem('sidebarWidth')) || 260,
             resizing: false,
             startResize(e) {
                 this.resizing = true;
                 const startX = e.clientX;
                 const startWidth = this.sidebarWidth;
                 
                 const moveHandler = (e) => {
                     const diff = e.clientX - startX;
                     this.sidebarWidth = Math.max(200, Math.min(600, startWidth + diff));
                 };
                 
                 const upHandler = () => {
                     this.resizing = false;
                     localStorage.setItem('sidebarWidth', this.sidebarWidth);
                     window.removeEventListener('mousemove', moveHandler);
                     window.removeEventListener('mouseup', upHandler);
                 };
                 
                 window.addEventListener('mousemove', moveHandler);
                 window.addEventListener('mouseup', upHandler);
             }
         }">
         
        <!-- Resizable Sidebar -->
        <aside class="flex flex-col bg-sidebar"
               :style="`width: ${sidebarWidth}px`">
            <div class="p-4 flex flex-col h-full">
                <!-- Environment (static) -->
                <div class="mb-6">
                    <h2 class="text-xs font-bold text-secondary uppercase mb-2">Environment</h2>
                    <div class="flex gap-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="env" value="docker" x-model="environment" class="mr-2">
                            <span>Docker</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="env" value="local" x-model="environment" class="mr-2">
                            <span>Local</span>
                        </label>
                    </div>
                </div>
                <!-- Service list (htmx-swapped) -->
                <div class="mb-6">
                    <h2 class="text-xs font-bold text-secondary uppercase mb-2">Services</h2>
                    <div id="sidebar"
                         hx-get="/api/services/health"
                         hx-trigger="load, every 10s"
                         hx-swap="innerHTML"
                         class="w-full text-xs">
                        <div class="text-secondary text-[10px]">Loading...</div>
                    </div>
                </div>
                <!-- Controls (static â€” not destroyed by htmx polls) -->
                <div class="mb-6 border-t border-gray-700 pt-4">
                    <h2 class="text-xs font-bold text-secondary uppercase mb-2">Controls</h2>
                    <div class="flex flex-col gap-2">
                        <div class="text-[10px] text-secondary text-center mb-1">
                            Target: <span x-text="selectedService === 'all' ? 'All Services' : selectedService" class="font-bold text-white"></span>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <button @click="startService()" :disabled="serviceActionPending"
                                    :class="serviceActionPending ? 'opacity-50 cursor-wait' : ''"
                                    class="btn text-[10px]">Start</button>
                            <button @click="restartService()" :disabled="serviceActionPending"
                                    :class="serviceActionPending ? 'opacity-50 cursor-wait' : ''"
                                    class="btn text-[10px]">Restart</button>
                            <button @click="stopService()" :disabled="serviceActionPending"
                                    :class="serviceActionPending ? 'opacity-50 cursor-wait' : ''"
                                    class="btn text-[10px] text-red-300 hover:text-red-100">Stop</button>
                        </div>
                        <div x-show="serviceStatusMsg" x-text="serviceStatusMsg"
                             class="text-[10px] text-center text-yellow-300 mt-1"></div>
                        <button @click="warmOllama()" :disabled="warmingOllama"
                                :class="warmingOllama ? 'opacity-50 cursor-wait' : ''"
                                class="btn text-[10px] w-full mt-2">
                            <span x-show="!warmingOllama">ðŸ”¥ Warm Ollama</span>
                            <span x-show="warmingOllama">Warming...</span>
                        </button>
                    </div>
                </div>
                <div class="flex-1"></div>
            </div>
        </aside>

        <!-- Resize Handle -->
        <div class="resize-handle" 
             @mousedown.prevent="startResize" 
             :class="{ 'resizing': resizing }"></div>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col overflow-hidden bg-dark">
            <!-- Tab Bar -->
            <nav class="flex border-b border-gray-700 bg-gray-900 text-xs">
                <button @click="activeTab = 'lab'; htmx.trigger(document.body, 'refresh-lab')" :class="activeTab === 'lab' ? 'nav-tab-active' : 'nav-tab'" class="px-4 py-2 outline-none" title="Submit and monitor events">Events</button>
                <button @click="activeTab = 'response'; htmx.trigger(document.body, 'refresh-response')" :class="activeTab === 'response' ? 'nav-tab-active' : 'nav-tab'" class="px-4 py-2 outline-none" title="Event decision history">Response</button>
                <button @click="activeTab = 'heuristics'; htmx.trigger(document.body, 'refresh-heuristics')" :class="activeTab === 'heuristics' ? 'nav-tab-active' : 'nav-tab'" class="px-4 py-2 outline-none" title="Manage heuristics">Heuristics</button>
                <button @click="activeTab = 'learning'; htmx.trigger(document.body, 'refresh-learning')" :class="activeTab === 'learning' ? 'nav-tab-active' : 'nav-tab'" class="px-4 py-2 outline-none" title="Heuristic fire history">Learning</button>
                <button @click="activeTab = 'llm'; htmx.trigger(document.body, 'refresh-llm')" :class="activeTab === 'llm' ? 'nav-tab-active' : 'nav-tab'" class="px-4 py-2 outline-none" title="Ollama status and testing">LLM</button>
                <button @click="activeTab = 'logs'; htmx.trigger(document.body, 'refresh-logs')" :class="activeTab === 'logs' ? 'nav-tab-active' : 'nav-tab'" class="px-4 py-2 outline-none" title="Service log viewer">Logs</button>
                <div class="flex-1"></div>
                <button @click="activeTab = 'settings'; htmx.trigger(document.body, 'refresh-settings')" :class="activeTab === 'settings' ? 'nav-tab-active' : 'nav-tab'" class="px-4 py-2 outline-none" title="Environment config and cache">Settings</button>
            </nav>

            <!-- Tab Content -->
            <div class="flex-1 overflow-auto p-4">
                <div x-show="activeTab === 'lab'" hx-get="/api/components/lab" hx-trigger="load, refresh-lab from:body" hx-swap="innerHTML" class="h-full"></div>
                <div x-show="activeTab === 'response'" hx-get="/api/components/response" hx-trigger="load, refresh-response from:body" hx-swap="innerHTML" class="h-full"></div>
                <div x-show="activeTab === 'heuristics'" hx-get="/api/components/heuristics" hx-trigger="load, refresh-heuristics from:body" hx-swap="innerHTML" class="h-full"></div>
                <div x-show="activeTab === 'learning'" hx-get="/api/components/learning" hx-trigger="load, refresh-learning from:body" hx-swap="innerHTML"></div>
                <div x-show="activeTab === 'llm'" hx-get="/api/components/llm" hx-trigger="load, refresh-llm from:body" hx-swap="innerHTML"></div>
                <div x-show="activeTab === 'logs'" hx-get="/api/components/logs" hx-trigger="load, refresh-logs from:body" hx-swap="innerHTML"></div>
                <div x-show="activeTab === 'settings'" hx-get="/api/components/settings" hx-trigger="load, refresh-settings from:body" hx-swap="innerHTML"></div>
            </div>
        </main>
    </div>

    <script src="/js/app.js"></script>
    <script src="/js/events.js"></script>
</body>
</html>